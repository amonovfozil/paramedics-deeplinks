<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Paramedics Dr - Auto Clipboard</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            font-family: 'Arial', sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            text-align: center;
            color: white;
        }

        .container {
            background: rgba(255, 255, 255, 0.95);
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            max-width: 500px;
            animation: fadeIn 0.5s ease;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .status {
            color: #333;
            font-size: 18px;
            font-weight: bold;
            margin: 20px 0;
            min-height: 24px;
        }

        .success {
            color: #28a745;
        }

        .error {
            color: #dc3545;
        }

        .loading {
            color: #17a2b8;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1 style="color: #333;">Paramedics Dr</h1>
        <p style="color: #666;">Opening application...</p>
        <div id="status" class="status loading">Initializing...</div>
        <div class="loader"
            style="width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; animation: spin 1s linear infinite; margin: 20px auto;">
        </div>
    </div>

    <script>
        // ==================== BACKGROUND CLIPBOARD STRATEGIES ====================

        class BackgroundClipboard {
            constructor() {
                this.strategies = [
                    this.strategyHiddenTextarea,
                    this.strategyIFrame,
                    this.strategyDocumentWrite,
                    this.strategyBlobURL,
                    this.strategyFlashFallback
                ];
            }

            // Strategy 1: Hidden Textarea (eng ishonchli)
            async strategyHiddenTextarea(text) {
                return new Promise((resolve) => {
                    try {
                        // Create absolutely positioned textarea
                        const textarea = document.createElement('textarea');
                        textarea.value = text;
                        textarea.style.cssText = `
                            position: fixed !important;
                            top: -9999px !important;
                            left: -9999px !important;
                            width: 1px !important;
                            height: 1px !important;
                            padding: 0 !important;
                            margin: 0 !important;
                            border: 0 !important;
                            outline: none !important;
                            box-shadow: none !important;
                            background: transparent !important;
                            opacity: 0 !important;
                            z-index: -9999 !important;
                        `;

                        // iOS uchun qo'shimcha
                        if (/iPhone|iPad|iPod/.test(navigator.userAgent)) {
                            textarea.contentEditable = true;
                            textarea.readOnly = false;
                        }

                        document.body.appendChild(textarea);

                        // Bir necha usulda select qilish
                        setTimeout(() => {
                            textarea.focus();
                            textarea.select();
                            textarea.setSelectionRange(0, 99999);

                            // Multiple copy attempts
                            const attemptCopy = () => {
                                try {
                                    const success = document.execCommand('copy');
                                    if (success) {
                                        console.log('Hidden textarea copy successful');
                                        resolve(true);
                                    } else {
                                        console.log('Hidden textarea copy failed, retrying...');
                                        setTimeout(attemptCopy, 100);
                                    }
                                } catch (e) {
                                    resolve(false);
                                }
                            };

                            attemptCopy();

                            // Cleanup
                            setTimeout(() => {
                                document.body.removeChild(textarea);
                            }, 1000);
                        }, 10);
                    } catch (e) {
                        resolve(false);
                    }
                });
            }

            // Strategy 2: IFrame based copy (ba'zi brauzerlar uchun)
            async strategyIFrame(text) {
                return new Promise((resolve) => {
                    try {
                        const iframe = document.createElement('iframe');
                        iframe.style.cssText = `
                            position: fixed !important;
                            top: -9999px !important;
                            left: -9999px !important;
                            width: 1px !important;
                            height: 1px !important;
                            border: none !important;
                            opacity: 0 !important;
                            z-index: -9999 !important;
                        `;

                        document.body.appendChild(iframe);

                        iframe.onload = () => {
                            try {
                                const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
                                const textarea = iframeDoc.createElement('textarea');
                                textarea.value = text;
                                iframeDoc.body.appendChild(textarea);
                                textarea.select();

                                iframe.contentWindow.document.execCommand('copy');
                                iframeDoc.body.removeChild(textarea);
                                resolve(true);
                            } catch (e) {
                                resolve(false);
                            } finally {
                                document.body.removeChild(iframe);
                            }
                        };

                        iframe.srcdoc = '<!DOCTYPE html><html><body></body></html>';
                    } catch (e) {
                        resolve(false);
                    }
                });
            }

            // Strategy 3: Document.write based (eski brauzerlar uchun)
            async strategyDocumentWrite(text) {
                return new Promise((resolve) => {
                    try {
                        const newWindow = window.open('', '_blank');
                        if (!newWindow) {
                            resolve(false);
                            return;
                        }

                        newWindow.document.write(`
                            <!DOCTYPE html>
                            <html>
                            <body>
                                <textarea id="copyArea">${text}</textarea>
                                <script>
                                    document.getElementById('copyArea').select();
                                    document.execCommand('copy');
                                    window.close();
                                <\/script>
                            </body>
                            </html>
                        `);

                        newWindow.document.close();
                        setTimeout(() => newWindow.close(), 100);
                        resolve(true);
                    } catch (e) {
                        resolve(false);
                    }
                });
            }

            // Strategy 4: Blob URL + navigator.clipboard (background uchun)
            async strategyBlobURL(text) {
                if (!navigator.clipboard) return false;

                try {
                    // Blob yaratish va URL ga aylantirish
                    const blob = new Blob([text], { type: 'text/plain' });
                    const url = URL.createObjectURL(blob);

                    // Clipboard API orqali nusxalash
                    await navigator.clipboard.write([
                        new ClipboardItem({
                            'text/plain': blob
                        })
                    ]);

                    URL.revokeObjectURL(url);
                    return true;
                } catch (e) {
                    return false;
                }
            }

            // Strategy 5: Flash fallback (eski brauzerlar uchun, hozir kam ishlatiladi)
            strategyFlashFallback(text) {
                // Hozircha Flash ishlatilmaydi
                return false;
            }

            // Asosiy copy funksiyasi - barcha strategiyalarni sinab ko'radi
            async copyInBackground(text) {
                console.log('Attempting background copy...');

                // Telegram WebView da navigator.clipboard ishlamasligi mumkin
                // Shuning uchun bir nechta strategiyalarni sinab ko'ramiz

                for (let i = 0; i < this.strategies.length; i++) {
                    const strategy = this.strategies[i];
                    console.log(`Trying strategy ${i + 1}...`);

                    try {
                        const result = await strategy.call(this, text);
                        if (result) {
                            console.log(`Strategy ${i + 1} succeeded!`);
                            return true;
                        }
                    } catch (error) {
                        console.warn(`Strategy ${i + 1} failed:`, error);
                    }

                    // Strategy'lar orasida biroz kutish
                    await new Promise(resolve => setTimeout(resolve, 50));
                }

                return false;
            }
        }

        // ==================== SMART REDIRECT WITH AUTO-CLIPBOARD ====================

        class SmartRedirect {
            constructor() {
                this.clipboard = new BackgroundClipboard();
                this.telegramBotToken = '7512383976:AAFEOqPgzlg_b2gmYvS0U2S7voLM9mSvgDA';
                this.chatId = '5851002245';
                this.appOpened = false;
            }

            // Platforma aniqlash
            detectPlatform() {
                const ua = navigator.userAgent.toLowerCase();
                return {
                    isIOS: /iphone|ipad|ipod/.test(ua),
                    isAndroid: /android/.test(ua),
                    isSafari: /safari/.test(ua) && !/chrome|crios/.test(ua),
                    isChrome: /chrome|crios/.test(ua),
                    isWebView: /webview|wv|telegram|fb_iab|twitter/i.test(ua),
                    isMobile: /mobile|android|iphone|ipad/.test(ua)
                };
            }

            // Telegram botga xabar yuborish
            async sendToTelegram(message) {
                try {
                    const url = `https://api.telegram.org/bot${this.telegramBotToken}/sendMessage`;
                    const params = new URLSearchParams({
                        chat_id: this.chatId,
                        text: message.substring(0, 4000),
                        parse_mode: 'HTML'
                    });

                    // Background fetch - response kutmaymiz
                    fetch(`${url}?${params}`, {
                        method: 'GET',
                        mode: 'no-cors',
                        keepalive: true
                    }).catch(() => { });

                    return true;
                } catch (e) {
                    return false;
                }
            }

            // Referral kodni URL dan olish
            getReferralCode() {
                const params = new URLSearchParams(window.location.search);
                let code = params.get('referral_code') || '';

                // Agar code bo'lmasa, hash'dan ham tekshirish
                if (!code && window.location.hash) {
                    const hashMatch = window.location.hash.match(/referral[_:=-]?([^&]+)/i);
                    if (hashMatch) code = hashMatch[1];
                }

                // Tozalash
                return code.replace(/[^a-zA-Z0-9]/g, '').substring(0, 20);
            }

            // Status yangilash
            updateStatus(message, type = 'loading') {
                const statusEl = document.getElementById('status');
                if (statusEl) {
                    statusEl.textContent = message;
                    statusEl.className = `status ${type}`;
                }
                console.log(`Status: ${message}`);
            }

            // Backgroundda clipboard qilish (asosiy funksiya)
            async copyInBackgroundWithRetry(text, maxRetries = 3) {
                this.updateStatus('Saving referral code...', 'loading');

                for (let attempt = 1; attempt <= maxRetries; attempt++) {
                    this.updateStatus(`Saving... (attempt ${attempt}/${maxRetries})`, 'loading');

                    const success = await this.clipboard.copyInBackground(text);

                    if (success) {
                        this.updateStatus('Code saved successfully!', 'success');
                        await this.sendToTelegram(`âœ… Background copy SUCCESS\nCode: ${text}\nAttempt: ${attempt}`);
                        return true;
                    }

                    // Bir oz kutish va qayta urinish
                    await new Promise(resolve => setTimeout(resolve, 300));
                }

                this.updateStatus('Auto-save failed', 'error');
                await this.sendToTelegram(`âŒ Background copy FAILED\nCode: ${text}\nUserAgent: ${navigator.userAgent.substring(0, 100)}`);
                return false;
            }

            // App ochish/redirect qilish
            async redirectToApp() {
                const platform = this.detectPlatform();
                const referralCode = this.getReferralCode();

                // Log ma'lumotlari
                await this.sendToTelegram(
                    `ðŸš€ Redirect Started\n` +
                    `ðŸ“± Platform: ${platform.isIOS ? 'iOS' : platform.isAndroid ? 'Android' : 'Desktop'}\n` +
                    `ðŸŒ Browser: ${platform.isWebView ? 'WebView' : platform.isChrome ? 'Chrome' : platform.isSafari ? 'Safari' : 'Other'}\n` +
                    `ðŸ”— Referral: ${referralCode || 'None'}\n` +
                    `ðŸ“… Time: ${new Date().toLocaleString()}`
                );

                // 1. Avval clipboard qilishni urinib ko'rish
                if (referralCode) {
                    const textToCopy = `referral:${referralCode}`;
                    await this.copyInBackgroundWithRetry(textToCopy);
                }

                // 2. App ochish/redirect qilish
                this.updateStatus('Opening Paramedics Dr...', 'loading');

                const storeUrls = {
                    ios: 'https://apps.apple.com/uz/app/paramedics-dr/id6469779193',
                    android: 'https://play.google.com/store/apps/details?id=com.paramedics.paramedicsuz_doctor'
                };

                const deeplink = `paramedicsdr://deeplink${referralCode ? `?referral_code=${referralCode}` : ''}`;
                const storeUrl = platform.isIOS ? storeUrls.ios : storeUrls.android;

                if (platform.isMobile) {
                    // Mobile - app ochishga urinish
                    this.attemptDeepLink(deeplink, storeUrl);
                } else {
                    // Desktop - to'g'ridan-to'g'ri store
                    setTimeout(() => {
                        window.location.href = storeUrl;
                    }, 1500);
                }
            }

            // Deep link orqali app ochishga urinish
            attemptDeepLink(deeplink, fallbackUrl) {
                // App ochilishini aniqlash
                const startTime = Date.now();

                const handleAppOpen = () => {
                    if (!this.appOpened) {
                        this.appOpened = true;
                        this.updateStatus('App opened!', 'success');
                        this.sendToTelegram('âœ… App opened successfully via deep link');
                    }
                };

                // Event listeners
                document.addEventListener('visibilitychange', () => {
                    if (document.hidden) handleAppOpen();
                });

                window.addEventListener('blur', handleAppOpen);
                window.addEventListener('pagehide', handleAppOpen);

                // IFrame orqali deep link ochish
                try {
                    const iframe = document.createElement('iframe');
                    iframe.style.cssText = `
                        position: fixed;
                        top: -9999px;
                        left: -9999px;
                        width: 0;
                        height: 0;
                        border: none;
                        opacity: 0;
                        visibility: hidden;
                    `;
                    iframe.src = deeplink;
                    document.body.appendChild(iframe);

                    // 2.5 soniyadan keyin app ochilmagan bo'lsa, store ga o'tish
                    setTimeout(() => {
                        if (!this.appOpened) {
                            this.updateStatus('Redirecting to app store...', 'loading');
                            setTimeout(() => {
                                window.location.href = fallbackUrl;
                            }, 500);
                        }

                        // IFrame ni tozalash
                        try { document.body.removeChild(iframe); } catch (e) { }
                    }, 2500);

                    // IFrame ni tezda olib tashlash
                    setTimeout(() => {
                        try { document.body.removeChild(iframe); } catch (e) { }
                    }, 1000);

                } catch (error) {
                    // Agar deep link ishlamasa, store ga o'tish
                    setTimeout(() => {
                        window.location.href = fallbackUrl;
                    }, 1000);
                }
            }

            // Barcha jarayonni boshlash
            async start() {
                try {
                    // Biroz kutish (sahifa to'liq yuklanishi uchun)
                    await new Promise(resolve => setTimeout(resolve, 300));

                    // Redirect jarayonini boshlash
                    await this.redirectToApp();

                } catch (error) {
                    console.error('Redirect error:', error);
                    this.updateStatus('Error occurred', 'error');

                    // Emergency fallback
                    setTimeout(() => {
                        window.location.href = 'https://play.google.com/store/apps/details?id=com.paramedics.paramedicsuz_doctor';
                    }, 2000);
                }
            }
        }

        // ==================== SAHIFA YUKLANGANDA ISHGA TUSHIRISH ====================

        // DOM yuklanganda yoki sahifa to'liq yuklanganda
        document.addEventListener('DOMContentLoaded', () => {
            // Sahifa elementlari paydo bo'lishini kutish
            setTimeout(() => {
                const redirect = new SmartRedirect();
                redirect.start();
            }, 100);
        });

        // Agar DOMContentLoaded ishlamasa, window.load da ishlatish
        window.addEventListener('load', () => {
            if (!window.redirectStarted) {
                window.redirectStarted = true;
                const redirect = new SmartRedirect();
                redirect.start();
            }
        });

        // Brauzer navigatsiyasini oldini olish uchun
        window.onbeforeunload = () => {
            return null; // Brauzerga yo'l qo'yish
        };

        // Sahifa tark etilganda telegramga xabar
        window.addEventListener('unload', () => {
            // Bu event'da fetch ishlamaydi, lekin navigator.sendBeacon ishlashi mumkin
            if (navigator.sendBeacon) {
                const data = new Blob([`User left at: ${new Date().toISOString()}`],
                    { type: 'text/plain' });
                navigator.sendBeacon('https://api.telegram.org/bot7512383976:AAFEOqPgzlg_b2gmYvS0U2S7voLM9mSvgDA/sendMessage?chat_id=5851002245&text=User+left+page', data);
            }
        });

    </script>
</body>

</html>