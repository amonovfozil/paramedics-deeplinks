<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Paramedics Dr</title>

    <style>
        /* RESET */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #ffffff;
            /* OQ FON */
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            text-align: center;
            padding: 20px;
        }

        .container {
            max-width: 400px;
            width: 100%;
        }

        .logo {
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, #1a73e8 0%, #0d47a1 100%);
            border-radius: 20px;
            margin: 0 auto 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 32px;
            font-weight: bold;
        }

        h1 {
            color: #333;
            margin-bottom: 10px;
            font-size: 24px;
        }

        .subtitle {
            color: #666;
            margin-bottom: 30px;
        }

        /* LOADER */
        .loader-container {
            margin: 30px 0;
        }

        .loader {
            width: 60px;
            height: 60px;
            border: 4px solid #f0f0f0;
            border-top: 4px solid #1a73e8;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        /* STATUS */
        .status {
            color: #666;
            font-size: 14px;
            margin-top: 20px;
            min-height: 40px;
        }

        /* ANIMATIONS */
        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        /* HIDDEN */
        .hidden {
            display: none !important;
        }

        /* SUCCESS MESSAGE (faqat ko'rinadi, keyin yopiladi) */
        .success-message {
            background: #4CAF50;
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
            animation: fadeInOut 2s ease-in-out;
        }

        @keyframes fadeInOut {
            0% {
                opacity: 0;
                transform: translateY(10px);
            }

            20% {
                opacity: 1;
                transform: translateY(0);
            }

            80% {
                opacity: 1;
                transform: translateY(0);
            }

            100% {
                opacity: 0;
                transform: translateY(-10px);
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="logo">P</div>

        <h1>Paramedics Dr</h1>
        <p class="subtitle">Opening app...</p>

        <!-- LOADER -->
        <div class="loader-container">
            <div class="loader"></div>
        </div>

        <!-- STATUS -->
        <div class="status" id="status">Initializing...</div>

        <!-- SUCCESS MESSAGE (avtomatik ko'rinib keyin yopiladi) -->
        <div class="success-message hidden" id="successMessage">
            ‚úÖ Redirect successful! Closing...
        </div>
    </div>

    <script>
        // ====== KONFIGURATSIYA ======
        const CONFIG = {
            APP_SCHEME: 'paramedicsdr://deeplink',

            // Store app scheme lar
            PLAY_STORE_APP: 'market://details?id=com.paramedics.paramedicsuz_doctor',
            PLAY_STORE_WEB: 'https://play.google.com/store/apps/details?id=com.paramedics.paramedicsuz_doctor',

            APP_STORE_APP: 'itms-apps://itunes.apple.com/app/id6469779193',
            APP_STORE_WEB: 'https://apps.apple.com/uz/app/paramedics-dr/id6469779193',

            // Vaqt sozlamalari (millisekundlarda)
            INITIAL_DELAY: 300,      // Dastlabki kutish
            APP_ATTEMPT_DELAY: 800,  // App ochish urinishi
            STORE_APP_DELAY: 1200,   // Store app ochish
            STORE_WEB_DELAY: 2000,   // Store web ochish (agar app yo'q bo'lsa)

            // Browser yopish vaqtlari
            CLOSE_IMMEDIATE: 100,    // Darhol yopish uchun
            CLOSE_SHORT: 500,        // Qisqa kutish
            CLOSE_NORMAL: 1000,      // Normal kutish
            CLOSE_LONG: 2000,        // Uzoq kutish

            // Xotira
            STORAGE_KEY: 'paramedics_referral',
            STORAGE_EXPIRY_DAYS: 7
        };

        // ====== ELEMENTLAR ======
        const statusEl = document.getElementById('status');
        const successMsg = document.getElementById('successMessage');

        // ====== STATE ======
        let state = {
            platform: null,
            params: null,
            appOpened: false,
            storeOpened: false,
            redirectCompleted: false
        };

        // ====== UTILITY FUNKSIYALAR ======

        // Platform aniqlash
        function detectPlatform() {
            const ua = navigator.userAgent || navigator.vendor || window.opera;

            if (/iPad|iPhone|iPod/.test(ua) && !window.MSStream) {
                return 'ios';
            } else if (/Android/.test(ua)) {
                return 'android';
            } else {
                return 'desktop';
            }
        }

        // URL parametrlarini olish
        function getUrlParams() {
            const urlParams = new URLSearchParams(window.location.search);
            const params = {};

            if (urlParams.has('referral_code')) {
                params.referral_code = urlParams.get('referral_code');
            }
            if (urlParams.has('user_id')) {
                params.user_id = urlParams.get('user_id');
            }
            if (urlParams.has('page_name')) {
                params.page_name = urlParams.get('page_name');
            }

            return Object.keys(params).length > 0 ? params : null;
        }

        // Xotiraga saqlash
        function saveToStorage(params) {
            if (!params) return;

            try {
                const storageData = {
                    params: params,
                    timestamp: Date.now(),
                    expires: Date.now() + (CONFIG.STORAGE_EXPIRY_DAYS * 24 * 60 * 60 * 1000),
                    url: window.location.href
                };

                localStorage.setItem(CONFIG.STORAGE_KEY, JSON.stringify(storageData));
                console.log('‚úÖ Saved to storage:', params);

            } catch (e) {
                console.log('‚ùå Storage error:', e);
            }
        }

        // Status yangilash
        function updateStatus(message) {
            if (statusEl) {
                statusEl.textContent = message;
            }
            console.log('üì¢ Status:', message);
        }

        // Success message ko'rsatish va yopish
        function showSuccessAndClose() {
            if (successMsg) {
                successMsg.classList.remove('hidden');

                // 2 soniyadan keyin yashirish
                setTimeout(() => {
                    successMsg.classList.add('hidden');
                }, 2000);
            }
        }

        // ====== BROWSER YOPISH FUNKSIYALARI ======

        // Browser ni yopishga urinish (asosiy funksiya)
        function attemptCloseBrowser() {
            console.log('üö™ Attempting to close browser...');

            // 1. Avval history.back() orqali urinish
            try {
                if (window.history.length > 1) {
                    console.log('‚Ü©Ô∏è Using history.back()');
                    window.history.back();
                    return true;
                }
            } catch (e) {
                console.log('‚ö†Ô∏è history.back() failed:', e);
            }

            // 2. Agar ishlamasa, blank page ga o'tish
            try {
                console.log('üìÑ Replacing with blank page');
                document.body.innerHTML = `
                    <div style="text-align: center; padding: 50px;">
                        <h1 style="color: #4CAF50;">‚úÖ Success!</h1>
                        <p>You can now close this tab.</p>
                        <p style="color: #666; font-size: 12px; margin-top: 20px;">
                            This page will close automatically...
                        </p>
                    </div>
                `;

                // 3 soniyadan keyin close ga urinish
                setTimeout(() => {
                    try {
                        window.close();
                    } catch (e) {
                        console.log('‚ö†Ô∏è window.close() failed');
                    }
                }, 3000);

                return true;

            } catch (e) {
                console.log('‚ùå All close methods failed');
                return false;
            }
        }

        // Darhol yopish (agar mumkin bo'lsa)
        function closeImmediately() {
            console.log('‚ö° Attempting immediate close');
            return attemptCloseBrowser();
        }

        // Kutib turib yopish
        function closeAfterDelay(delay) {
            console.log(`‚è≥ Will close after ${delay}ms`);

            setTimeout(() => {
                attemptCloseBrowser();
            }, delay);
        }

        // ====== REDIRECT FUNKSIYALARI ======

        // App ochish
        function attemptOpenApp(params) {
            updateStatus('Opening Paramedics Dr...');

            let appLink = CONFIG.APP_SCHEME;
            if (params) {
                const query = new URLSearchParams(params).toString();
                appLink += '?' + query;
            }

            console.log('üîÑ Opening app:', appLink);
            window.location.href = appLink;
        }

        // Store APP ni ochish
        function openStoreApp() {
            if (state.platform === 'ios') {
                updateStatus('Opening App Store...');
                console.log('üçé Opening App Store app');
                window.location.href = CONFIG.APP_STORE_APP;
            } else if (state.platform === 'android') {
                updateStatus('Opening Play Store...');
                console.log('ü§ñ Opening Play Store app');
                window.location.href = CONFIG.PLAY_STORE_APP;
            }
        }

        // Store WEB ga o'tish
        function openStoreWeb() {
            updateStatus('Redirecting to store...');

            if (state.platform === 'ios') {
                console.log('üåê Opening App Store web');
                window.location.href = CONFIG.APP_STORE_WEB;
            } else {
                console.log('üåê Opening Play Store web');
                window.location.href = CONFIG.PLAY_STORE_WEB;
            }
        }

        // ====== EVENT HANDLERS ======

        // App ochilganda (blur event)
        function handleBlur() {
            console.log('üî¥ Window blurred');

            if (!state.appOpened) {
                state.appOpened = true;
                console.log('‚úÖ App/Store opened successfully');

                // Success message ko'rsatish
                showSuccessAndClose();

                // Browser ni darhol yopishga urinish
                setTimeout(() => {
                    closeImmediately();
                }, CONFIG.CLOSE_IMMEDIATE);
            }
        }

        // User qaytib kelsa (visibility change)
        function handleVisibilityChange() {
            if (document.visibilityState === 'visible') {
                console.log('‚Ü©Ô∏è User returned to browser');

                // Agar user qaytib kelsa va redirect hali bajarilmagan bo'lsa
                if (!state.redirectCompleted) {
                    // Store ga o'tish
                    if (state.platform === 'ios' || state.platform === 'android') {
                        openStoreApp();
                    } else {
                        openStoreWeb();
                    }

                    // 1 soniyadan keyin yopish
                    closeAfterDelay(CONFIG.CLOSE_NORMAL);
                }
            }
        }

        // Page yuklanganida
        function handleLoad() {
            console.log('‚úÖ Page loaded');

            // Agar sahifa to'liq yuklangan bo'lsa, app yo'q degani
            // Shuning uchun store ga o'tish kerak
            setTimeout(() => {
                if (!state.appOpened && !state.storeOpened) {
                    console.log('‚è∞ Timeout - app not installed');

                    if (state.platform === 'ios' || state.platform === 'android') {
                        openStoreApp();
                    } else {
                        openStoreWeb();
                    }

                    // Store ga o'tgandan keyin yopish
                    closeAfterDelay(CONFIG.CLOSE_LONG);
                }
            }, CONFIG.STORE_WEB_DELAY);
        }

        // ====== MAIN REDIRECT SEQUENCE ======

        function startRedirectSequence() {
            console.log('üöÄ Starting redirect sequence');

            // 1. Parametrlarni saqlash
            saveToStorage(state.params);

            // 2. App ochishga urinish
            setTimeout(() => {
                attemptOpenApp(state.params);
            }, CONFIG.APP_ATTEMPT_DELAY);

            // 3. Agar app ochilmagan bo'lsa, Store APP ga o'tish
            setTimeout(() => {
                if (!state.appOpened && (state.platform === 'ios' || state.platform === 'android')) {
                    console.log('‚è∞ App open timeout - trying store app');
                    openStoreApp();
                    state.storeOpened = true;

                    // Store app ochilganda browser ni yopish
                    closeAfterDelay(CONFIG.CLOSE_SHORT);
                }
            }, CONFIG.STORE_APP_DELAY);

            // 4. Agar store app ham ishlamasa, web ga (fallback)
            setTimeout(() => {
                if (!state.appOpened && !state.storeOpened) {
                    console.log('‚è∞ Store app timeout - trying web');
                    openStoreWeb();
                    state.redirectCompleted = true;
                }
            }, CONFIG.STORE_WEB_DELAY);
        }

        // ====== INITIALIZATION ======

        function init() {
            console.log('üéØ Initializing deep link handler');

            // State ni to'ldirish
            state.platform = detectPlatform();
            state.params = getUrlParams();

            console.log('üì± Platform:', state.platform);
            console.log('üì¶ Params:', state.params);

            updateStatus('Detecting platform...');

            // Event listenerlar
            window.addEventListener('blur', handleBlur);
            document.addEventListener('visibilitychange', handleVisibilityChange);
            window.addEventListener('load', handleLoad);
            window.addEventListener('beforeunload', () => {
                console.log('üìÑ Page unloading');
                state.appOpened = true;
            });

            // Redirect sequence ni boshlash
            setTimeout(() => {
                startRedirectSequence();
            }, CONFIG.INITIAL_DELAY);
        }

        // ====== START APPLICATION ======

        // DOM yuklanganda ishga tushirish
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', init);
        } else {
            init();
        }

        // Xatolarni log qilish
        window.addEventListener('error', (event) => {
            console.error('‚ùå Page error:', event.error);
            updateStatus('Error occurred');
        });

    </script>
</body>

</html>