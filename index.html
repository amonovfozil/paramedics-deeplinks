<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Paramedics Dr</title>

    <style>
        /* RESET */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #ffffff;
            /* OQ FON */
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            text-align: center;
            padding: 20px;
        }

        .container {
            max-width: 400px;
            width: 100%;
        }

        .logo {
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, #1a73e8 0%, #0d47a1 100%);
            border-radius: 20px;
            margin: 0 auto 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 32px;
            font-weight: bold;
        }

        h1 {
            color: #333;
            margin-bottom: 10px;
            font-size: 24px;
        }

        .subtitle {
            color: #666;
            margin-bottom: 30px;
        }

        /* LOADER */
        .loader-container {
            margin: 30px 0;
        }

        .loader {
            width: 60px;
            height: 60px;
            border: 4px solid #f0f0f0;
            border-top: 4px solid #1a73e8;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        /* STATUS */
        .status {
            color: #666;
            font-size: 14px;
            margin-top: 20px;
            min-height: 40px;
        }

        /* ANIMATIONS */
        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        /* HIDDEN */
        .hidden {
            display: none !important;
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="logo">P</div>

        <h1>Paramedics Dr</h1>
        <p class="subtitle">Opening app...</p>

        <!-- LOADER -->
        <div class="loader-container">
            <div class="loader"></div>
        </div>

        <!-- STATUS -->
        <div class="status" id="status">Initializing...</div>
    </div>

    <script>
        // ====== KONFIGURATSIYA ======
        const CONFIG = {
            APP_SCHEME: 'paramedicsdr://deeplink',

            // Store app scheme lar
            PLAY_STORE_APP: 'market://details?id=com.paramedics.paramedicsuz_doctor',
            PLAY_STORE_WEB: 'https://play.google.com/store/apps/details?id=com.paramedics.paramedicsuz_doctor',

            APP_STORE_APP: 'itms-apps://itunes.apple.com/app/id6469779193',
            APP_STORE_WEB: 'https://apps.apple.com/uz/app/paramedics-dr/id6469779193',

            // Vaqt sozlamalari (millisekundlarda)
            INITIAL_DELAY: 500,      // Dastlabki kutish
            APP_ATTEMPT_DELAY: 800,  // App ochish urinishi
            STORE_APP_DELAY: 1500,   // Store app ochish
            STORE_WEB_DELAY: 2500,   // Store web ochish (agar app yo'q bo'lsa)
            CLOSE_TIMEOUT: 3000,     // Browser yopish uchun timeout

            // Xotira
            STORAGE_KEY: 'paramedics_referral',
            STORAGE_EXPIRY_DAYS: 7
        };

        // ====== ELEMENTLAR ======
        const statusEl = document.getElementById('status');

        // ====== FUNKSIYALAR ======

        // Platformani aniqlash
        function detectPlatform() {
            const ua = navigator.userAgent || navigator.vendor || window.opera;

            if (/iPad|iPhone|iPod/.test(ua) && !window.MSStream) {
                return 'ios';
            } else if (/Android/.test(ua)) {
                return 'android';
            } else {
                return 'desktop';
            }
        }

        // URL parametrlarini olish
        function getUrlParams() {
            const urlParams = new URLSearchParams(window.location.search);
            const params = {};

            // Faqat kerakli parametrlar
            if (urlParams.has('referral_code')) {
                params.referral_code = urlParams.get('referral_code');
            }
            if (urlParams.has('user_id')) {
                params.user_id = urlParams.get('user_id');
            }
            if (urlParams.has('page_name')) {
                params.page_name = urlParams.get('page_name');
            }

            return Object.keys(params).length > 0 ? params : null;
        }

        // Xotiraga saqlash
        function saveToStorage(params) {
            if (!params) return;

            try {
                const storageData = {
                    params: params,
                    timestamp: Date.now(),
                    expires: Date.now() + (CONFIG.STORAGE_EXPIRY_DAYS * 24 * 60 * 60 * 1000),
                    url: window.location.href
                };

                // 1. LocalStorage
                localStorage.setItem(CONFIG.STORAGE_KEY, JSON.stringify(storageData));

                // 2. SessionStorage (tezroq)
                sessionStorage.setItem('current_referral', JSON.stringify(params));

                console.log('‚úÖ Parametrlar xotirada saqlandi:', params);

            } catch (e) {
                console.log('‚ùå Xotira saqlash xatosi:', e);
            }
        }

        // Status yangilash
        function updateStatus(message) {
            if (statusEl) {
                statusEl.textContent = message;
            }
            console.log('üì¢ Status:', message);
        }

        // App ochish (Universal Link)
        function attemptOpenApp(params) {
            updateStatus('Opening Paramedics Dr app...');

            // App link yaratish
            let appLink = CONFIG.APP_SCHEME;
            if (params) {
                const query = new URLSearchParams(params).toString();
                appLink += '?' + query;
            }

            console.log('üîÑ App ochilmoqda:', appLink);

            // App ni ochishga urinish
            window.location.href = appLink;

            return appLink;
        }

        // Store APP ni ochish (AppStore/PlayMarket app)
        function openStoreApp(platform) {
            if (platform === 'ios') {
                updateStatus('Opening App Store app...');
                window.location.href = CONFIG.APP_STORE_APP;
                return CONFIG.APP_STORE_APP;
            } else if (platform === 'android') {
                updateStatus('Opening Play Store app...');
                window.location.href = CONFIG.PLAY_STORE_APP;
                return CONFIG.PLAY_STORE_APP;
            }
            return null;
        }

        // Store WEB ga o'tish (agar app yo'q bo'lsa)
        function openStoreWeb(platform) {
            if (platform === 'ios') {
                updateStatus('Opening App Store in browser...');
                window.location.href = CONFIG.APP_STORE_WEB;
                return CONFIG.APP_STORE_WEB;
            } else if (platform === 'android') {
                updateStatus('Opening Play Store in browser...');
                window.location.href = CONFIG.PLAY_STORE_WEB;
                return CONFIG.PLAY_STORE_WEB;
            } else {
                // Desktop
                updateStatus('Redirecting to Play Store...');
                window.location.href = CONFIG.PLAY_STORE_WEB;
                return CONFIG.PLAY_STORE_WEB;
            }
        }

        // Browser ni yopishga urinish
        function attemptCloseBrowser() {
            console.log('üö™ Browser yopilmoqda...');

            try {
                // Mobile browser larni yopish
                if (window.history.length > 1) {
                    window.history.back();
                } else {
                    // Agar history bo'lmasa
                    document.body.innerHTML = `
                        <div style="text-align: center; padding: 50px;">
                            <h1>‚úÖ Success!</h1>
                            <p>You can now close this tab.</p>
                            <button onclick="window.close()" style="padding: 10px 20px; background: #1a73e8; color: white; border: none; border-radius: 5px; margin-top: 20px;">
                                Close Tab
                            </button>
                        </div>
                    `;
                }
            } catch (e) {
                console.log('‚ö†Ô∏è Browser yopish mumkin emas:', e);
            }
        }

        // Asosiy redirect logikasi
        function startRedirectSequence() {
            const platform = detectPlatform();
            const params = getUrlParams();

            console.log('üì± Platform:', platform);
            console.log('üì¶ Params:', params);

            // 1. Parametrlarni xotirada saqlash
            saveToStorage(params);

            // 2. App ochishga urinish
            setTimeout(() => {
                attemptOpenApp(params);
            }, CONFIG.APP_ATTEMPT_DELAY);

            // 3. Store APP ga o'tish (agar app ochilmagan bo'lsa)
            setTimeout(() => {
                if (platform === 'ios' || platform === 'android') {
                    const storeAppLink = openStoreApp(platform);
                    console.log('üõí Store app ochilmoqda:', storeAppLink);

                    // Store app ochilganda, browser ni yopish
                    setTimeout(() => {
                        attemptCloseBrowser();
                    }, CONFIG.CLOSE_TIMEOUT);

                } else {
                    // Desktop - to'g'ridan web ga
                    openStoreWeb(platform);
                }
            }, CONFIG.STORE_APP_DELAY);

            // 4. Agar store app ham yo'q bo'lsa, web ga (fallback)
            setTimeout(() => {
                if (platform !== 'desktop') {
                    openStoreWeb(platform);
                }
            }, CONFIG.STORE_WEB_DELAY);
        }

        // ====== EVENT HANDLERS ======

        // App ochilganda (blur event)
        let appOpened = false;
        let storeOpened = false;

        window.addEventListener('blur', function () {
            console.log('üî¥ Window blurred - app/store opened');

            // Kichik timeout bilan qaysi app ochilganligini aniqlash
            setTimeout(() => {
                if (!appOpened) {
                    appOpened = true;
                    console.log('‚úÖ Paramedics Dr app opened');

                    // Browser ni yopish
                    setTimeout(() => {
                        attemptCloseBrowser();
                    }, 500);
                }
            }, 100);

            setTimeout(() => {
                if (!appOpened && !storeOpened) {
                    storeOpened = true;
                    console.log('üõí Store app opened');
                }
            }, 500);
        });

        // User qaytib kelsa (visibility change)
        document.addEventListener('visibilitychange', function () {
            if (document.visibilityState === 'visible') {
                console.log('‚Ü©Ô∏è User returned to browser');

                // Agar user qaytib kelsa, store ga o'tish
                const platform = detectPlatform();
                if (platform === 'ios' || platform === 'android') {
                    openStoreApp(platform);
                } else {
                    openStoreWeb(platform);
                }
            }
        });

        // Page before unload
        window.addEventListener('beforeunload', function () {
            console.log('üìÑ Page unloading');
            appOpened = true;
        });

        // ====== INITIALIZATION ======

        // Sahifa yuklanganda
        window.addEventListener('DOMContentLoaded', function () {
            updateStatus('Initializing...');

            // Dastlabki kutish
            setTimeout(() => {
                startRedirectSequence();
            }, CONFIG.INITIAL_DELAY);
        });

        // Agar sahifa yuklanmasa
        window.addEventListener('load', function () {
            console.log('‚úÖ Page loaded successfully');
        });

        // Xatolik bo'lsa
        window.addEventListener('error', function (event) {
            console.error('‚ùå Page error:', event.error);
            updateStatus('Error occurred. Please try again.');
        });

    </script>
</body>

</html>