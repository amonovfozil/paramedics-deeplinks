<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Paramedics Dr</title>

    <style>
        /* RESET */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #ffffff;
            /* OQ FON */
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            text-align: center;
            padding: 20px;
        }

        .container {
            max-width: 400px;
            width: 100%;
        }

        .logo {
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, #1a73e8 0%, #0d47a1 100%);
            border-radius: 20px;
            margin: 0 auto 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 32px;
            font-weight: bold;
        }

        h1 {
            color: #333;
            margin-bottom: 10px;
            font-size: 24px;
        }

        .subtitle {
            color: #666;
            margin-bottom: 30px;
        }

        /* LOADER */
        .loader-container {
            margin: 30px 0;
        }

        .loader {
            width: 60px;
            height: 60px;
            border: 4px solid #f0f0f0;
            border-top: 4px solid #1a73e8;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        /* STATUS */
        .status {
            color: #666;
            font-size: 14px;
            margin-top: 20px;
            min-height: 40px;
        }

        /* ANIMATIONS */
        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        /* HIDDEN */
        .hidden {
            display: none !important;
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="logo">P</div>

        <h1>Paramedics Dr</h1>
        <p class="subtitle">Opening app...</p>

        <!-- LOADER -->
        <div class="loader-container">
            <div class="loader"></div>
        </div>

        <!-- STATUS -->
        <div class="status" id="status">Initializing...</div>
    </div>

    <script>
        // ====== TEZKOR KONFIGURATSIYA ======
        const CONFIG = {
            APP_SCHEME: 'paramedicsdr://deeplink',

            // Store scheme lar
            PLAY_STORE_APP: 'market://details?id=com.paramedics.paramedicsuz_doctor',
            PLAY_STORE_WEB: 'https://play.google.com/store/apps/details?id=com.paramedics.paramedicsuz_doctor',

            APP_STORE_APP: 'itms-apps://itunes.apple.com/app/id6469779193',
            APP_STORE_WEB: 'https://apps.apple.com/uz/app/paramedics-dr/id6469779193',

            // TEZKOR Vaqtlar (MILLISEKUND)
            INIT_DELAY: 200,        // Dastlabki kutish - 0.2s
            APP_REDIRECT_DELAY: 400, // App redirect - 0.4s
            STORE_REDIRECT_DELAY: 800, // Store redirect - 0.8s
            CLOSE_IMMEDIATE: 50,    // Darhol yopish - 0.05s
            CLOSE_SHORT: 100,       // Qisqa yopish - 0.1s

            // Xotira
            STORAGE_KEY: 'paramedics_referral',
            STORAGE_EXPIRY_DAYS: 7
        };

        // ====== ELEMENTLAR ======
        const statusEl = document.getElementById('status');

        // ====== STATE ======
        let state = {
            platform: null,
            params: null,
            redirectStarted: false,
            browserClosed: false
        };

        // ====== UTILITY FUNKSIYALAR ======

        // Tez platforma aniqlash
        function detectPlatform() {
            const ua = navigator.userAgent;
            if (/iPhone|iPad|iPod/.test(ua)) return 'ios';
            if (/Android/.test(ua)) return 'android';
            return 'desktop';
        }

        // Tez parametr olish
        function getUrlParams() {
            const urlParams = new URLSearchParams(window.location.search);
            const params = {};

            if (urlParams.has('referral_code')) params.referral_code = urlParams.get('referral_code');
            if (urlParams.has('user_id')) params.user_id = urlParams.get('user_id');
            if (urlParams.has('page_name')) params.page_name = urlParams.get('page_name');

            return Object.keys(params).length > 0 ? params : null;
        }

        // Tez xotiraga saqlash
        function saveToStorage(params) {
            if (!params) return;

            try {
                localStorage.setItem(CONFIG.STORAGE_KEY, JSON.stringify({
                    params: params,
                    timestamp: Date.now()
                }));
            } catch (e) {
                // Xotira xatosi - e'tiborsiz qoldirish
            }
        }

        // Status yangilash
        function updateStatus(message) {
            if (statusEl) statusEl.textContent = message;
        }

        // ====== BROWSER YOPISH (AVVAL) ======

        // Avval browser ni yopish
        function closeBrowserFirst() {
            if (state.browserClosed) return;
            state.browserClosed = true;

            console.log('ðŸšª Closing browser first...');

            // 1. Eng tez usul - history.back()
            try {
                if (window.history.length > 1) {
                    window.history.back();
                    return true;
                }
            } catch (e) { }

            // 2. Blank page ga o'tish
            try {
                // Minimal blank page
                document.body.innerHTML = '<div style="display:none"></div>';

                // Document ni close qilishga urinish
                setTimeout(() => {
                    try {
                        if (window.close && !window.closed) {
                            window.close();
                        }
                    } catch (e) { }
                }, 10);

                return true;
            } catch (e) { }

            return false;
        }

        // ====== REDIRECT (KEYIN) ======

        // App ga redirect (iframe orqali)
        function redirectToApp(params) {
            if (state.redirectStarted) return;
            state.redirectStarted = true;

            console.log('ðŸ”„ Redirecting to app...');
            updateStatus('Opening app...');

            // App link yaratish
            let appLink = CONFIG.APP_SCHEME;
            if (params) {
                const query = new URLSearchParams(params).toString();
                appLink += '?' + query;
            }

            // Iframe orqali redirect (background da)
            const iframe = document.createElement('iframe');
            iframe.style.display = 'none';
            iframe.src = appLink;
            document.body.appendChild(iframe);

            // Asosiy window dan ham urinish
            setTimeout(() => {
                window.location.href = appLink;
            }, 10);
        }

        // Store app ga redirect
        function redirectToStoreApp() {
            console.log('ðŸ›’ Redirecting to store app...');
            updateStatus('Opening store...');

            if (state.platform === 'ios') {
                // iOS - AppStore app
                window.location.href = CONFIG.APP_STORE_APP;
            } else if (state.platform === 'android') {
                // Android - Play Market app
                window.location.href = CONFIG.PLAY_STORE_APP;
            }
        }

        // Store web ga redirect (fallback)
        function redirectToStoreWeb() {
            console.log('ðŸŒ Redirecting to store web...');
            updateStatus('Opening store in browser...');

            if (state.platform === 'ios') {
                window.location.href = CONFIG.APP_STORE_WEB;
            } else {
                window.location.href = CONFIG.PLAY_STORE_WEB;
            }
        }

        // ====== ASOSIY LOGIKA ======

        function startProcess() {
            console.log('âš¡ Starting fast process...');

            // 1. State ni to'ldirish
            state.platform = detectPlatform();
            state.params = getUrlParams();

            console.log('ðŸ“± Platform:', state.platform);
            console.log('ðŸ“¦ Params:', state.params);

            // 2. Parametrlarni saqlash (background da)
            saveToStorage(state.params);

            // 3. Avval browser ni yopishga urinish
            setTimeout(() => {
                closeBrowserFirst();
            }, CONFIG.CLOSE_IMMEDIATE);

            // 4. App ga redirect
            setTimeout(() => {
                redirectToApp(state.params);
            }, CONFIG.APP_REDIRECT_DELAY);

            // 5. Agar app ochilmagan bo'lsa, store app ga
            setTimeout(() => {
                if (state.platform === 'ios' || state.platform === 'android') {
                    redirectToStoreApp();
                }
            }, CONFIG.STORE_REDIRECT_DELAY);

            // 6. Agar store app ham ishlamasa, web ga (fallback)
            setTimeout(() => {
                redirectToStoreWeb();
            }, CONFIG.STORE_REDIRECT_DELAY + 500);
        }

        // ====== EVENT HANDLERS ======

        // Page load bo'lganda
        window.addEventListener('load', function () {
            console.log('âœ… Page loaded');
            updateStatus('Ready...');

            // Tezroq boshlash
            setTimeout(startProcess, CONFIG.INIT_DELAY);
        });

        // Blur event - app/store ochilganda
        window.addEventListener('blur', function () {
            console.log('ðŸ”´ App/Store opened');

            // Darhol browser ni yopish
            setTimeout(() => {
                closeBrowserFirst();
            }, CONFIG.CLOSE_IMMEDIATE);
        });

        // Visibility change - user qaytib kelsa
        document.addEventListener('visibilitychange', function () {
            if (document.visibilityState === 'visible') {
                console.log('â†©ï¸ User returned');

                // User qaytib kelsa, store ga yo'naltirish
                if (state.platform === 'ios' || state.platform === 'android') {
                    redirectToStoreApp();
                } else {
                    redirectToStoreWeb();
                }

                // Yana yopishga urinish
                setTimeout(() => {
                    closeBrowserFirst();
                }, CONFIG.CLOSE_SHORT);
            }
        });

        // ====== INITIALIZATION ======

        // DOM ready bo'lganda ishga tushirish
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', function () {
                updateStatus('Starting...');
                console.log('ðŸŽ¯ DOM ready');
            });
        } else {
            updateStatus('Starting...');
            console.log('ðŸŽ¯ DOM already ready');
        }

    </script>
</body>

</html>